<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Chat History Dashboard - ISP PayBD</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-main: #f8fafc;
            --bg-card: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-icon {
            display: inline-block;
            font-size: 1.5rem;
            margin-right: 8px;
        }

        /* Filters */
        .filters {
            background: var(--bg-card);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .filters h3 {
            margin-bottom: 20px;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
            background: white;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding-left: 40px;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--text-secondary);
            color: white;
        }

        .btn-secondary:hover {
            opacity: 0.9;
        }

        /* Conversations List */
        .conversations-section {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .section-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h3 {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .conversation-card {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .conversation-card:hover {
            background: var(--bg-main);
        }

        .conversation-card:last-child {
            border-bottom: none;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .conversation-id {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .conversation-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .meta-item {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-user {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-anonymous {
            background: #f3f4f6;
            color: #6b7280;
        }

        .badge-en {
            background: #dcfce7;
            color: #166534;
        }

        .badge-bn {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-search {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 12px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .stat-icon {
            font-size: 1.2rem;
        }

        .stat-text {
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .view-arrow {
            font-size: 1.5rem;
            color: var(--primary-color);
            transition: transform 0.2s ease;
            flex-shrink: 0;
            margin-left: 20px;
        }

        .conversation-card:hover .view-arrow {
            transform: translateX(5px);
        }

        .conversation-separator {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 30px 0;
            padding: 15px 0;
        }

        .separator-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, transparent, var(--border-color), transparent);
        }

        .separator-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            text-align: center;
        }

        .separator-text small {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        /* Messages View */
        .messages-view {
            display: none;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
            margin-top: 20px;
        }

        .messages-view.active {
            display: block;
        }

        .messages-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .messages-list {
            padding: 24px;
            max-height: 600px;
            overflow-y: auto;
        }

        .message-item {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message-avatar.user {
            background: #dbeafe;
            color: #1e40af;
        }

        .message-avatar.assistant {
            background: #dcfce7;
            color: #166534;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .message-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .message-text {
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
            font-size: 0.9rem;
        }

        .message-item.user .message-text {
            background: #f1f5f9;
            color: var(--text-primary);
        }

        .message-item.assistant .message-text {
            background: #f0fdf4;
            color: var(--text-primary);
        }

        .message-meta {
            display: flex;
            gap: 15px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .message-meta-item {
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .level-low { color: #10b981; }
        .level-mid { color: #3b82f6; }
        .level-high { color: #f59e0b; }
        .level-critical { color: #ef4444; }
        .level-sensitive { color: #8b5cf6; }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 20px;
            border-top: 1px solid var(--border);
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .page-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .empty-state p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }

            .conversation-meta {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üí¨ Chat History Dashboard</h1>
            <p>View and analyze all conversations with advanced filtering and search</p>
        </div>
    </div>

    <div class="container">
        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">üìä Total Conversations</div>
                <div class="stat-value" id="statTotalConversations">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üí¨ Total Messages</div>
                <div class="stat-value" id="statTotalMessages">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üë• Active Users</div>
                <div class="stat-value" id="statActiveUsers">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">‚è±Ô∏è Avg Response Time</div>
                <div class="stat-value" id="statAvgResponse">0ms</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters">
            <h3>üîç Filters & Search</h3>
            <div class="filter-grid">
                <div class="filter-group search-box">
                    <label>Search Messages</label>
                    <span class="search-icon">üîç</span>
                    <input type="text" id="searchInput" placeholder="Search by content...">
                </div>
                <div class="filter-group">
                    <label>User ID</label>
                    <input type="text" id="filterUserId" placeholder="e.g., 10854">
                </div>
                <div class="filter-group">
                    <label>Session Type</label>
                    <select id="filterSessionType">
                        <option value="">All Types</option>
                        <option value="user">Authenticated</option>
                        <option value="anonymous">Anonymous</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Language</label>
                    <select id="filterLanguage">
                        <option value="">All Languages</option>
                        <option value="EN">English</option>
                        <option value="BN">Bangla</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Date From</label>
                    <input type="date" id="filterDateFrom">
                </div>
                <div class="filter-group">
                    <label>Date To</label>
                    <input type="date" id="filterDateTo">
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-primary" onclick="applyFilters()">
                    <span>üîç</span> Apply Filters
                </button>
                <button class="btn btn-secondary" onclick="resetFilters()">
                    <span>üîÑ</span> Reset
                </button>
            </div>
        </div>

        <!-- Conversations List -->
        <div class="conversations-section">
            <div class="section-header">
                <h3>üë• Users</h3>
                <button class="btn btn-secondary" onclick="loadUsersList()">
                    <span>üîÑ</span> Refresh
                </button>
            </div>
            <div id="conversationsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading conversations...</p>
                </div>
            </div>
            <div class="pagination" id="pagination" style="display: none;">
                <button id="prevPage" onclick="previousPage()">‚Üê Previous</button>
                <span class="page-info" id="pageInfo">Page 1 of 1</span>
                <button id="nextPage" onclick="nextPage()">Next ‚Üí</button>
            </div>
        </div>

        <!-- Messages View -->
        <div class="messages-view" id="messagesView">
            <div class="messages-header">
                <h3 id="messagesTitle">Conversation Messages</h3>
                <button class="btn btn-secondary" onclick="closeMessages()">
                    <span>‚úï</span> Close
                </button>
            </div>
            <div class="messages-list" id="messagesList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading messages...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};
        let selectedUserId = null;
        let viewMode = 'users'; // 'users' or 'conversations'

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('‚úÖ Page loaded, initializing dashboard...');
            loadStatistics();
            loadUsersList();
            
            // Setup search input listener
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(handleSearch, 500));
                console.log('‚úÖ Search input listener attached');
            } else {
                console.error('‚ùå Search input element not found');
            }
        });

        // Load Statistics
        async function loadStatistics() {
            try {
                const response = await fetch('/api/history/health');
                const data = await response.json();
                
                document.getElementById('statTotalConversations').textContent = data.total_conversations || 0;
                document.getElementById('statTotalMessages').textContent = data.total_messages || 0;

                // Load daily stats
                const statsResponse = await fetch('/api/history/statistics/daily?days=30');
                const statsData = await statsResponse.json();
                
                if (statsData.statistics && statsData.statistics.length > 0) {
                    // Calculate total from all days
                    const totalMessages = statsData.statistics.reduce((sum, s) => sum + s.total_messages, 0);
                    const totalTokens = statsData.statistics.reduce((sum, s) => sum + s.total_tokens, 0);
                    const avgResponseTimes = statsData.statistics.filter(s => s.avg_response_time_ms > 0);
                    const avgResponse = avgResponseTimes.length > 0 
                        ? Math.round(avgResponseTimes.reduce((sum, s) => sum + s.avg_response_time_ms, 0) / avgResponseTimes.length)
                        : 0;
                    
                    document.getElementById('statAvgResponse').textContent = avgResponse + 'ms';
                    
                    // Count unique users
                    const uniqueUsers = new Set(statsData.statistics.map(s => s.user_id).filter(u => u));
                    document.getElementById('statActiveUsers').textContent = uniqueUsers.size;
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Load Users List (Grouped View)
        async function loadUsersList() {
            viewMode = 'users';
            const list = document.getElementById('conversationsList');
            list.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading users...</p></div>';
            
            document.getElementById('pagination').style.display = 'none';

            try {
                // Build query params from filters (FastAPI 422 if unknown params are sent)
                const params = new URLSearchParams();
                params.set('skip', '0');
                params.set('limit', '1000');
                if (currentFilters.userId) params.set('user_id', currentFilters.userId.trim());
                if (currentFilters.sessionType) params.set('session_type', currentFilters.sessionType);
                if (currentFilters.language) params.set('language', currentFilters.language);
                if (currentFilters.dateFrom) params.set('date_from', currentFilters.dateFrom);
                if (currentFilters.dateTo) params.set('date_to', currentFilters.dateTo);

                const response = await fetch(`/api/history/conversations?${params.toString()}`, {
                    headers: { 'Cache-Control': 'no-cache' },
                    cache: 'no-store'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);

                if (!data || !data.conversations || !Array.isArray(data.conversations)) {
                    console.error('Invalid response:', data);
                    throw new Error('Invalid response format: conversations array not found');
                }

                // Group by user_id
                const userGroups = {};
                data.conversations.forEach(conv => {
                    const userId = conv.user_id || 'Anonymous';
                    if (!userGroups[userId]) {
                        userGroups[userId] = {
                            userId: userId,
                            conversations: [],
                            totalMessages: 0,
                            totalTokens: 0,
                            languages: new Set(),
                            lastActivity: conv.updated_at,
                            firstActivity: conv.created_at
                        };
                    }
                    userGroups[userId].conversations.push(conv);
                    userGroups[userId].totalMessages += conv.total_messages;
                    userGroups[userId].totalTokens += conv.total_tokens_used;
                    userGroups[userId].languages.add(conv.language);
                    
                    // Update last activity
                    if (new Date(conv.updated_at) > new Date(userGroups[userId].lastActivity)) {
                        userGroups[userId].lastActivity = conv.updated_at;
                    }
                    // Update first activity
                    if (new Date(conv.created_at) < new Date(userGroups[userId].firstActivity)) {
                        userGroups[userId].firstActivity = conv.created_at;
                    }
                });

                // Convert to array and sort by last activity
                const users = Object.values(userGroups).sort((a, b) => 
                    new Date(b.lastActivity) - new Date(a.lastActivity)
                );

                if (users.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <h3>No Users Found</h3>
                            <p>No chat history available.</p>
                        </div>
                    `;
                    return;
                }

                list.innerHTML = users.map(user => `
                    <div class="conversation-card user-card" onclick="viewUserMessages('${user.userId}')">
                        <div class="conversation-header">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                    <div class="user-avatar">
                                        ${user.userId === 'Anonymous' ? 'üë§' : user.userId.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <div class="conversation-id" style="font-size: 1.1rem;">
                                            ${user.userId === 'Anonymous' ? 'üëª Anonymous Users' : 'üë§ User ID: ' + user.userId}
                                        </div>
                                        <div class="conversation-meta" style="margin-top: 5px;">
                                            <span class="badge ${user.userId === 'Anonymous' ? 'badge-anonymous' : 'badge-user'}">
                                                ${user.conversations.length} conversation${user.conversations.length !== 1 ? 's' : ''}
                                            </span>
                                            ${Array.from(user.languages).map(lang => 
                                                `<span class="badge badge-${lang.toLowerCase()}">${lang}</span>`
                                            ).join('')}
                                        </div>
                                    </div>
                                </div>
                                <div class="user-stats">
                                    <div class="stat-item">
                                        <span class="stat-icon">üí¨</span>
                                        <span class="stat-text">${user.totalMessages} messages</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-icon">ü™ô</span>
                                        <span class="stat-text">${user.totalTokens} tokens</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-icon">üìÖ</span>
                                        <span class="stat-text">Last: ${formatRelativeTime(user.lastActivity)}</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-icon">üïê</span>
                                        <span class="stat-text">First: ${formatRelativeTime(user.firstActivity)}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="view-arrow">‚Üí</div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading users:', error);
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <h3>Error Loading Users</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadUsersList()" style="margin-top: 15px;">
                            üîÑ Try Again
                        </button>
                    </div>
                `;
            }
        }

        // View All Messages for a User (Grouped by conversation)
        async function viewUserMessages(userId) {
            selectedUserId = userId;
            const view = document.getElementById('messagesView');
            const list = document.getElementById('messagesList');
            
            view.classList.add('active');
            document.getElementById('messagesTitle').innerHTML = `
                ${userId === 'Anonymous' ? 'üëª Anonymous User' : 'üë§ User ID: ' + userId} - All Messages
            `;
            
            list.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading all messages...</p></div>';

            try {
                // Use the new dedicated endpoint for all user messages
                const endpoint = userId === 'Anonymous' 
                    ? '/api/history/users/anonymous/messages?limit=1000'
                    : `/api/history/users/${userId}/messages?limit=1000`;
                
                const response = await fetch(endpoint);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('User messages:', data);

                if (!data.messages || data.messages.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <h3>No Messages</h3>
                            <p>This user has no messages yet.</p>
                        </div>
                    `;
                    return;
                }

                // Group messages by conversation for display
                let currentConvId = null;
                let html = `
                    <div style="padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 12px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 10px 0;">üìä Summary</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            <div><strong>${data.total_messages}</strong> messages</div>
                            <div><strong>${data.conversations_count}</strong> conversations</div>
                        </div>
                    </div>
                `;

                data.messages.forEach((msg) => {
                    // Add conversation separator if new conversation
                    if (msg.conversation_id !== currentConvId) {
                        currentConvId = msg.conversation_id;
                        html += `
                            <div class="conversation-separator">
                                <span class="separator-line"></span>
                                <span class="separator-text">
                                    üìù Conversation: ${msg.conversation_id.slice(0, 35)}...
                                    <br>
                                    <small>Started: ${formatDateTime(msg.conversation_created)} | Language: ${msg.language}</small>
                                </span>
                                <span class="separator-line"></span>
                            </div>
                        `;
                    }

                    html += `
                        <div class="message-item ${msg.role}">
                            <div class="message-avatar ${msg.role}">
                                ${msg.role === 'user' ? 'üë§' : 'ü§ñ'}
                            </div>
                            <div class="message-content">
                                <div class="message-header">
                                    <span class="message-sender">${msg.role === 'user' ? 'User' : 'AI Assistant'}</span>
                                    <span class="message-time">${formatDateTime(msg.created_at)}</span>
                                </div>
                                <div class="message-text">${escapeHtml(msg.content)}</div>
                                <div class="message-meta">
                                    <span class="message-meta-item level-${msg.message_level}">
                                        üîí ${msg.message_level.toUpperCase()}
                                    </span>
                                    ${msg.category ? `<span class="message-meta-item">üìÇ ${msg.category}</span>` : ''}
                                    ${msg.tokens_used > 0 ? `<span class="message-meta-item">ü™ô ${msg.tokens_used} tokens</span>` : ''}
                                    ${msg.response_time_ms > 0 ? `<span class="message-meta-item">‚è±Ô∏è ${Math.round(msg.response_time_ms)}ms</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });

                list.innerHTML = html;

            } catch (error) {
                console.error('Error loading user messages:', error);
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <h3>Error Loading Messages</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="viewUserMessages('${userId}')" style="margin-top: 15px;">
                            üîÑ Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Close Messages View
        function closeMessages() {
            document.getElementById('messagesView').classList.remove('active');
            selectedUserId = null;
        }

        // Apply Filters
        function applyFilters() {
            currentFilters = {
                userId: document.getElementById('filterUserId').value,
                sessionType: document.getElementById('filterSessionType').value,
                language: document.getElementById('filterLanguage').value,
                dateFrom: document.getElementById('filterDateFrom').value,
                dateTo: document.getElementById('filterDateTo').value
            };
            loadUsersList();
        }

        // Reset Filters
        function resetFilters() {
            document.getElementById('filterUserId').value = '';
            document.getElementById('filterSessionType').value = '';
            document.getElementById('filterLanguage').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('searchInput').value = '';
            currentFilters = {};
            loadUsersList();
        }

        // Pagination (not used in user view, but kept for compatibility)
        function updatePagination(data) {
            const pagination = document.getElementById('pagination');
            pagination.style.display = 'none';
        }

        function previousPage() {
            // Not used in user grouped view
        }

        function nextPage() {
            // Not used in user grouped view
        }

        // Search Handler
        async function handleSearch(e) {
            const searchTerm = e.target.value.trim();
            if (searchTerm.length < 2) {
                loadUsersList();
                return;
            }

            const list = document.getElementById('conversationsList');
            list.innerHTML = '<div class="loading"><div class="spinner"></div><p>Searching...</p></div>';

            try {
                const response = await fetch(`/api/history/search?q=${encodeURIComponent(searchTerm)}&limit=200`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Search results:', data);

                if (!data.messages || data.messages.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üîç</div>
                            <h3>No Results Found</h3>
                            <p>No messages found matching "${escapeHtml(searchTerm)}"</p>
                        </div>
                    `;
                    return;
                }

                // Group results by user_id
                const userGroups = {};
                data.messages.forEach(msg => {
                    const userId = msg.user_id || 'Anonymous';
                    if (!userGroups[userId]) {
                        userGroups[userId] = {
                            userId: userId,
                            matches: [],
                            conversations: new Set()
                        };
                    }
                    userGroups[userId].matches.push(msg);
                    userGroups[userId].conversations.add(msg.conversation_id);
                });

                const users = Object.values(userGroups);

                list.innerHTML = users.map(user => `
                    <div class="conversation-card user-card" onclick="viewUserMessages('${user.userId}')">
                        <div class="conversation-header">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                                    <div class="user-avatar">
                                        ${user.userId === 'Anonymous' ? 'üë§' : user.userId.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <div class="conversation-id" style="font-size: 1.1rem;">
                                            ${user.userId === 'Anonymous' ? 'üëª Anonymous Users' : 'üë§ User ID: ' + user.userId}
                                        </div>
                                        <div class="conversation-meta" style="margin-top: 5px;">
                                            <span class="badge badge-search">
                                                üîç ${user.matches.length} match${user.matches.length > 1 ? 'es' : ''} in ${user.conversations.size} conversation${user.conversations.size > 1 ? 's' : ''}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 8px; padding: 10px; background: var(--bg-secondary); border-radius: 6px; font-size: 0.85rem;">
                                    <strong>Sample match:</strong><br>
                                    ${highlightSearch(escapeHtml(user.matches[0].content.substring(0, 150)), searchTerm)}...
                                </div>
                            </div>
                            <div class="view-arrow">‚Üí</div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Search error:', error);
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <h3>Search Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Utility Functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDateTime(dateString) {
            return new Date(dateString).toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)}w ago`;
            if (diffDays < 365) return `${Math.floor(diffDays / 30)}mo ago`;
            return `${Math.floor(diffDays / 365)}y ago`;
        }

        function highlightSearch(text, searchTerm) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark style="background: #fef08a; padding: 2px 4px; border-radius: 3px;">$1</mark>');
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>
